## 1. Redis哨兵

### 1.1 哨兵作用

> ***面试官：Redis哨兵知道吧？***

哨兵的含义是什么？我们来看看百度百科的解释。

> 哨兵，汉语词语，是指站岗、放哨、巡逻、稽查的士兵

Redis主从架构也有自己的哨兵，名为Sentinel。Sentinel是什么含义，我们看看英文含义，很遗憾这个英文起名没有什么故事可讲，英文意思还是哨兵。

Redis哨兵本质是一个运行在特殊模式下的Redis服务器，并不是特殊要另外部署的服务模块。哨兵可以是一个，如果公司资金充足的话，部署由多个Sentinel实例组成的哨兵系统也是可以的。

那哨兵有什么作用？

它的主要作用是通过检测Redis主从服务器的下线状态，**选举出新Redis主服务器**，也就是**故障转移**，来保证Redis的高可用性。

### 1.2 检测主从下线状态

> ***面试官：你说说是怎么检测Redis主从服务器的下线状态的？***

我们先来讲讲哨兵最重要的第一个功能，检测Redis主从服务器下线状态，后面我们再来讲讲故障转移。

哨兵检测主从服务器下线状态有两种方式，分为主观和客观，我们可以给哨兵配置其中一种。

（1）**检测主观下线状态**：默认情况Sentinel会每隔 1 s向Redis主、从服务器发送PING命令，通过PING命令返回的信息来判断Redis主从服务器的下线状态。

（2）**检测客观下线状态**：Sentinl在主观判断下线后，会向其他Sentinel进行询问**是否同意**该节点已下线，当标记下线的**数量足够多**就会判断客观下线。

下面是哨兵们和Redis主从服务器之间藕断丝连的关系。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/41279bc71813415bb35dd0f59a3c5d9e.png#pic_center)

### 1.3 检测下线状态不一致

> ***面试官：有没有A哨兵判断Redis实例下线，但B哨兵判断Redis实例仍然存活的情况？***

各个**哨兵的配置**对检测下线的配置不同，可能会产品奇奇怪怪的问题，大家要注意下。

假如我们的A、B两个哨兵配置的是检测主观下线状态，哨兵会判断Redis实例进入主观下线**所需的响应时间长度**。

南哥假设A哨兵的配置是10000毫秒、B哨兵是50000毫秒，但此时Redis实例要在20000毫秒才响应，像这种情况就会发生A哨兵判断Redis实例下线，但B哨兵判断Redis实例仍然存活的情况。

## 2. 哨兵选举

### 2.1 选举领头哨兵

> ***面试官：领头哨兵怎么选举出来的？***

大家注意不要把领头哨兵和Redis主服务器弄混淆了，不然可就尴尬了哈。

南哥先说说领头哨兵的作用，免得大家误解。**领头Sentinel**起到执行故障转移的作用，也就是**选举出新的Redis主服务器**，而且只有当Redis主服务器被判断**客观下线**后才会选举出领头Sentinel。

那领头哨兵要怎么选择出来呢？选举出这个天选之子。

Sentinel哨兵设置局部领头Sentinel的规则是**先到先得**。

最先向**目标Sentinel**发送设置要求的源Sentinel将成为目标Sentinel的**局部领头Sentinel**，而之后接收到的所有设置要求都会被目标Sentinel拒绝。

如果有某个Sentinel被**半数以上**的Sentinel设置成了局部领头Sentinel，那么这个Sentinel就会成为领头Sentinel。

### 2.2  选举Redis主服务器

> ***面试官：知道怎么选举新的Redis主服务器吗？***

看到这，我来和大家讲讲哨兵最重要的第二个功能：选举出新的Redis主服务器。

（1）领头Sentinel会将已下线Redis主服务器的所有Redis从服务器保存到一个列表里面。

（2）通过**删除策略**，删除所有处于下线或者断线状态的、删除最近五秒内没有回复过领头Sentinel命令的、删除与已下线主服务器连接断开超过10毫秒的。

（3）如果有多个相同优先级的从服务器，将按照**复制偏移量**进行排序选出偏移量最大的，复制偏移量最大也就是数据同步最新的。

（4）最后选出的Redis实例也就成为新的Redis主服务器。